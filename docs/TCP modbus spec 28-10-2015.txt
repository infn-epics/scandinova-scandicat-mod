ScandiCAT ModbusTCP specification   Revision history Rev no  00  Author JG  Reviewer   Approver   Description Initial  Sign   Sign  Sign  Rev no  01  Author JG  Reviewer   Approver   Description CosyLabs input  Sign   Sign  Sign  Rev no  02  Author JG  Reviewer   Approver   Description New addressing scheme and some comments has been moved from the registry list to simplify import from xml  Rev no  03  Author JG  Reviewer   Approver   Description New variables: Input word 8,120-124  Rev no  04  Author JG  Reviewer   Approver   Description New stuff…  Sign   Sign  Sign  Rev no  05  Author FH  Reviewer   Approver   Description Mirror variables added and some updated variables.  Sign   Sign  Sign  Rev no  06  Author FH  Reviewer   Approver   Description Added phase shifter variables.  Sign   Sign  Sign  Rev no  07  Author FH  Reviewer   Approver   Description Added variables for SolPS2, SolPS3, Collector power, Body Power.  Sign   Sign  Sign  Rev no  08  Author FH  Reviewer   Approver   Description Added variables for Collector TempDiff and Body TempDiff.  Sign   Sign  Sign     1. Introduction 1.1. The internal Modbus TCP server enables communication over an Ethernet connection (TCP/IP, 100Mbit or 1000Mbit, IPv4 or IPv6) using the Modbus protocol.  1.2. Modbus is an open standard in industrial communication which is maintained by the independent Modbus Organization. The official specification can be found here: http://www.modbus.org/docs/Modbus_Messaging_Implementation_Guide_V1_0b.pdf  Here you find a good tutorial: http://www.rtaautomation.com/modbustcp/  1.3. Refresh rate depends on how big CPU is used in the modulator and also the size/complexity of the modulator, large data such as log-files or waveforms will be slower.  1.4. This protocol is not intended for synchronous streaming of data, such communication can be handled via the optional EtherCAT interface.  1.5. This document identifies only the most common ModbusTCP registers, your modulator may have more registers depending on size / complexity / other neworks / your preferences.  1.6. The file Recources.xml should be used by your system as a look-up table for strings, and simplifies the understanding of the state machine related registers:  StateTarget StateRead EventLogg MainEvent FirstInterlockEvent  1.7. All registers are little-endian (Intel order)  1.8. The Modbus-TCP server is located at “C:\TwinCAT\TcModbusSrv” and uses the following configuration file “ScandiCAT ModbusTCP.xml” located in the same folder (the registry list below is imported from this xml)    1.9. Event log (Address 1000-1649) Reading the eventLogg is optional (you can control the modulator without this) Here the fifty last events of the modulator are made available in eight FIFO arrays Usage: Poll Incr[0] every second, if Incr[0}<>IncrPrev (your local variable) copy the first index of each array to your own event storage and continue to evaluate Incr[1], if Incr[1]<>IncrPrev continue to copy the next index of each array and so on until Incr[n]=IncrPrev. Finally copy Incr[0] to IncrPrev. Optionally you could also add a check that new events must be newer than the previous by comparing TimeStamp[n]<> TimeStampPrev (your local variable)  1.10. MainEvent (Address 1700-1712) Reading the MainEvent is optional (you can control the modulator without this) Actual modulator state in the event format, priority: 1. Errors (when not active first interlock is showed instead) 2. First interlock (when not active warning is showed instead) 3. Warning (when not active state is showed instead) 4. State  1.11. FirstInterlockEvent (Address 1715-1727) Reading the FirstInterlockEvent is optional (you can control the modulator without this). This is a copy of the first interlock since previous reset, after reset this event type is set to 0 to indicate not active  1.12. ReadMatrix (Address 2000-2255) Reading the ReadMatrix is optional (you can control the modulator without this) In the following two arrays you can see the state of all units of the modulator. See MatrixItems in GUI Resource.xml    2. ModbusTCP registers  Registers mapping  InputRegisters  StartAddress  EndAddress  Type  Unit  General  Function  VarName  0  0  Int16    Modbus-TCP protocol identification number  Id number of protocol (can be different for different customers)  .gp_iModbusProtocolId  1  1  Int16    Modbus-TCP protocol revision number  Rev number of protocol (updated each time this document changes)  .gp_iModbusProtocolRev  2  2  Uint16    The previously received Modbus-TCP watchdog value  Copied from the ModbusTcpWatchdog holding register, can be used by the master to monitor this communication  SR_SlowCall.IFB_ExtComSts.uiModbusTcpWatchdogPrev  3  3  Int16    The actual state of the modulator  (* See Strings\State in GUI Resource.xml *) This is the actual state of the MSM (Main State Machine), example: StateTarget and StateRead are both "Trig" (13) A solenoid interlock is tripped, this interlock was configured to interlock the "Hv" state (9), therefore StateTarget is immediately set to the target level below which is "StandBy" (5). Now all units immediately go to "StandBy" and report their state to the MSM, when the MSM find that all units are at "StandBy" it sets the iStateRead to "StandBy". At the same time StatusBits.HvInlkExist is set to TRUE Also two events are added to the EventLogg, first the interlock event and then the state event (“StandBy”) Additionally the interlock event is copied to FirstInterlockEvent in case multiple interlocks occur in sequence this first interlock copy will not be overwritten until a reset is received)  .g_iStateRead  4  4  Uint16    A word containing 16 status bit's  Bit0: StbInlkExist Bit1: HvInlkExist Bit2: TrigInlkExist Bit3: WarningExist Bit4: OutsideLimits Bit5: Error Bit6: Spare Bit7: Spare Bit8: Spare Bit9: Spare Bit10: Spare Bit11: Spare Bit12: Spare Bit13: Spare Bit14: Spare Bit15: Spare  .g_wStatusBits  5  5  Int16    The current access level  See Strings\Message 0-3 in GUI Resource.xml  .g_iAccessLevel  6  7  Single    Remaining time of the delay  Filament warm-up timer  SR_SlowCall.IFB_SlowKly.IFB_Delay[1].rTimeRemaining  8  9  Single    Pulse repetition frequency  Pulse repetition frequency read value  SR_FastCall.IFB_FastTi.IFB_PrfRead.atq_rPrfRead  20  20  Single    Modulator target state  Currently used setvalue  .g_iStateTarget  21  22  Single  V  Voltage setvalue of all Ccps  Currently used setvalue  .gp_rVoltSet  23  24  Single  A  Filament current setvalue  Currently used setvalue  SR_FastCall.IFB_FastKly.IFB_FastFilPS.IFB_CurrSet.p_rSet1  25  26  Single  µs  Pulse width setvalue of all SU's  Currently used setvalue  .gp_rPlswthSet  100  101  Single  V  Voltage read value of Capacitor Charging Power Supply no 1  Scaled readvalue  SR_FastCall.IFB_Ccps.IFB_CcpsUnit[1].IFB_VoltRead.atq_rRead  102  103  Single  V  Voltage read value of Capacitor Charging Power Supply no 2  Scaled readvalue  SR_FastCall.IFB_Ccps.IFB_CcpsUnit[2].IFB_VoltRead.atq_rRead  104  105  Single  V  Voltage read value of Capacitor Charging Power Supply no 3  Scaled readvalue  SR_FastCall.IFB_Ccps.IFB_CcpsUnit[3].IFB_VoltRead.atq_rRead  106  107  Single  V  Voltage read value of Capacitor Charging Power Supply no 4  Scaled readvalue  SR_FastCall.IFB_Ccps.IFB_CcpsUnit[4].IFB_VoltRead.atq_rRead  108  109  Single  V  Voltage read value of Capacitor Charging  Scaled readvalue  SR_FastCall.IFB_Ccps.IFB_CcpsUnit[5].IFB_VoltRead.atq_rRead  Power Supply no 5  120  120  Word    Interlock status bits of Capacitor Charging Power Supply no 1  Bit0 "Mains interlock" Bit1 "PwmPulseCount interlock" Bit2 "IsaqCom interlock" Bit3 "SoftStart interlock" Bit4 "Igbt interlock" Bit5 "PhaseLoss interlock" Bit6 "TransformerTemp interlock" Bit7 "RectifierTemp interlock" Bit8 "IgbtTemp interlock" Bit9 "OverVoltage interlock" Bit10 "OverCurrent interlock" Bit11 "OptoFiberDarkTimeout"  SR_FastCall.IFB_Ccps.IFB_CcpsUnit[1].IFB_DigitalInputWord.wTempWord  121  121  Word    Interlock status bits of Capacitor Charging Power Supply no 2  Bit0 "Mains interlock" Bit1 "PwmPulseCount interlock" Bit2 "IsaqCom interlock" Bit3 "SoftStart interlock" Bit4 "Igbt interlock" Bit5 "PhaseLoss interlock" Bit6 "TransformerTemp interlock" Bit7 "RectifierTemp interlock" Bit8 "IgbtTemp interlock" Bit9 "OverVoltage interlock" Bit10 "OverCurrent interlock" Bit11 "OptoFiberDarkTimeout"  SR_FastCall.IFB_Ccps.IFB_CcpsUnit[2].IFB_DigitalInputWord.wTempWord  122  122  Word    Interlock status bits of Capacitor Charging Power Supply no 3  Bit0 "Mains interlock" Bit1 "PwmPulseCount interlock" Bit2 "IsaqCom interlock" Bit3 "SoftStart interlock" Bit4 "Igbt interlock" Bit5 "PhaseLoss interlock" Bit6 "TransformerTemp interlock" Bit7 "RectifierTemp interlock" Bit8 "IgbtTemp interlock" Bit9 "OverVoltage interlock" Bit10 "OverCurrent interlock" Bit11 "OptoFiberDarkTimeout"  SR_FastCall.IFB_Ccps.IFB_CcpsUnit[3].IFB_DigitalInputWord.wTempWord  123  123  Word    Interlock status bits of Capacitor Charging Power Supply no 4  Bit0 "Mains interlock" Bit1 "PwmPulseCount interlock" Bit2 "IsaqCom interlock" Bit3 "SoftStart interlock" Bit4 "Igbt interlock" Bit5 "PhaseLoss interlock" Bit6 "TransformerTemp interlock" Bit7 "RectifierTemp interlock" Bit8 "IgbtTemp interlock" Bit9 "OverVoltage interlock" Bit10 "OverCurrent interlock" Bit11 "OptoFiberDarkTimeout"  SR_FastCall.IFB_Ccps.IFB_CcpsUnit[4].IFB_DigitalInputWord.wTempWord  124  124  Word    Interlock status bits of Capacitor Charging Power Supply no 5  Bit0 "Mains interlock" Bit1 "PwmPulseCount interlock" Bit2 "IsaqCom interlock" Bit3 "SoftStart interlock" Bit4 "Igbt interlock" Bit5 "PhaseLoss interlock" Bit6 "TransformerTemp interlock" Bit7 "RectifierTemp interlock" Bit8 "IgbtTemp interlock" Bit9 "OverVoltage interlock" Bit10 "OverCurrent interlock" Bit11 "OptoFiberDarkTimeout"  SR_FastCall.IFB_Ccps.IFB_CcpsUnit[5].IFB_DigitalInputWord.wTempWord  200  201  Single  A  Current readvalue of the filament power supply  Scaled readvalue  SR_FastCall.IFB_FastKly.IFB_FastFilPs.IFB_CurrRead.atq_rRead  202  203  Single  V  Voltage readvalue of the filament power supply  Scaled readvalue  SR_FastCall.IFB_FastKly.IFB_FastFilPs.IFB_VoltRead.atq_rRead  300  301  Single  nA  Current readvalue of the ion pump controller 1  Scaled readvalue  SR_FastCall.IFB_FastKly.IFB_FastIonPS[1].IFB_CurrRead.atq_rRead  302  303  Single  kV  Voltage readvalue of the ion pump controller 1  Scaled readvalue  SR_FastCall.IFB_FastKly.IFB_FastIonPS[1].IFB_VoltRead.atq_rRead  400  401  Single  A  Current readvalue of solenoid power supply 1  Scaled readvalue  SR_FastCall.IFB_FastKly.IFB_FastSolPS[1].IFB_CurrRead.atq_rRead  402  403  Single  V  Voltage readvalue of solenoid power supply 1  Scaled readvalue  SR_FastCall.IFB_FastKly.IFB_FastSolPS[1].IFB_VoltRead.atq_rRead  404  405  Single  A  Current readvalue of solenoid power supply 2  Scaled readvalue  SR_FastCall.IFB_FastKly.IFB_FastSolPS[2].IFB_CurrRead.atq_rRead  406  407  Single  V  Voltage readvalue of solenoid power supply 2  Scaled readvalue  SR_FastCall.IFB_FastKly.IFB_FastSolPS[2].IFB_VoltRead.atq_rRead  408  409  Single  A  Current readvalue of solenoid power supply 3  Scaled readvalue  SR_FastCall.IFB_FastKly.IFB_FastSolPS[3].IFB_CurrRead.atq_rRead  410  411  Single  V  Voltage readvalue of solenoid power supply 3  Scaled readvalue  SR_FastCall.IFB_FastKly.IFB_FastSolPS[3].IFB_VoltRead.atq_rRead  500  501  Single  A  Current Transformer readvalue  Scaled read value of the pulse current amplitude  SR_FastCall.IFB_FastTank.IFB_Digi.IFB_CtRead.atq_rRead  502  503  Single  kV  Capacitive voltage-divider readvalue  Scaled read value of the pulse voltage amplitude  SR_FastCall.IFB_FastTank.IFB_Digi.IFB_CvdRead.atq_rRead  504  505  Single  µs  Full Width Half Maximum readvalue  Scaled read value of the pulse width at 50% height of the current pulse  SR_FastCall.IFB_FastTank.IFB_Digi.IFB_FwhmRead.atq_rRead  600  601  Single  ºC  Oil temperature readvalue  Scaled readvalue  SR_SlowCall.IFB_SlowTank.IFB_OilTemperature.atq_rRead  602  603  Single  mm  Oil level readvalue  Scaled readvalue of the oil level (0mm at Klystron min specification)  SR_SlowCall.IFB_SlowTank.IFB_OilLevel.atq_rRead  700  701  Single  ºC  Collector inlet water temperature  Scaled readvalue  SR_SlowCall.IFB_Cool.IFB_TempSensors[1].atq_rRead  702  703  Single  ºC  Collector outlet water temperature  Scaled readvalue  SR_SlowCall.IFB_Cool.IFB_TempSensors[2].atq_rRead  704  705  Single  ºC  Body inlet water temperature  Scaled readvalue  SR_SlowCall.IFB_Cool.IFB_TempSensors[3].atq_rRead  706  707  Single  ºC  Body outlet water temperature  Scaled readvalue  SR_SlowCall.IFB_Cool.IFB_TempSensors[4].atq_rRead  708  709  Single  ºC  Body temperature  Scaled readvalue  SR_SlowCall.IFB_Cool.IFB_TempSensors[5].atq_rRead  710  711  Single  ºC  Solenoid temperature  Scaled readvalue  SR_SlowCall.IFB_Cool.IFB_TempSensors[6].atq_rRead  740  741  Single  ºC  Collector temperature difference between outlet and inlet.  Scaled readvalue  SR_SlowCall.IFB_Cool.IFB_TempDiffCollector.atq_rRead  742  743  Single  ºC  Body temperature difference between outlet and inlet.  Scaled readvalue  SR_SlowCall.IFB_Cool.IFB_TempDiffBody.atq_rRead  750  751  Single  kW  Collector power  Scaled readvalue  SR_SlowCall.IFB_Cool. IFB_FlowPowerCollector.atq_rRead  752  753  Single  kW  Body power  Scaled readvalue  SR_SlowCall.IFB_Cool. IFB_FlowPowerBody.atq_rRead  800  801  Single  º  Phase shifter read value  Scaled readvalue  SR_FastCall.IFB_FastKly.IFB_PhaseShifter.rAngleRead  1000  1049  Uint16    Event logg increment array  Incremented for each new event, this enables GUI to see if new events has ocurred  .g_aEventsIncr  1050  1099  Uint16    Event logg type array  0=State, 1=Warning, 2=Interlock, 3=Error, 4=Parameter, 5=Message  .g_aEventsType  1100  1299  Uint64    Event logg time-stamp array  TYPE T_FILETIME : STRUCT dwLowDateTime : DWORD; dwHighDateTime : DWORD; END_STRUCT END_TYPE The T_FILETIME structure is a 64-bit value representing the number of 100-nanosecond intervals since January 1, 1601 (UTC). (Since modbus doesn’t support Uint64 you have to read four words per timestamp)  .g_aEventsTime  1300  1399  Uint32    Event logg trig id array  The current trig id/count  .g_aEventsTrigId  1400  1449  Uint16    Event logg index array  Shows which item that generated this event, see Matrixltems in GUI Resource.xml  .g_aEventsIndex  1450  1499  Uint16    Event logg text number array  See GUI Resource.xml\Strings, Type determines sub-element  .g_aEventsTextNo  1500  1549  Uint16    Event logg data type array  0=No data, 1=Real, 2=Bool, 3=Int, 4=Uint, 5=Word, 6=Dint, 7=Udint, 8=Dword  .g_aEventsDataType  1550  1649  Uint32    Event logg data array  Here data for the event can be entered, if DataType indicates NoData then this value is random  .g_aEventsData  1700  1712  Struct    Main event struct  This can be used to present the actual state of the modulator, you see State, Warnings, FirstInterlock and Error messages STRUCT  .g_stMainEvent  Incr : Uint16; (addr: 1700) Type : Uint16; (addr: 1701) TimeStamp : Uint64; (addr: 1702) TrigId : Uint32; (addr: 1706) Index : Uint16; (addr: 1708) TextNo : Uint16; (addr: 1709) DataType : Uint16; (addr: 1710) Data : Uint32; (addr: 1711) END_STRUCT  1715  1727  Struct    Main event struct  Displays the first interlock event since previous reset, the Type element will indicate active interlock whith the value 2 and inactive/resetted with the value 0 STRUCT Incr : Uint16; (addr: 1715) Type : Uint16; (addr: 1716) TimeStamp : Uint64; (addr: 1717) TrigId : Uint32; (addr: 1721) Index : Uint16; (addr: 1723) TextNo : Uint16; (addr: 1724) DataType : Uint16; (addr: 1725) Data : Uint32; (addr: 1726) END_STRUCT  .g_stFirstInterlockEvent  2000  2255  Uint16    State read array  In this array you can see the actual state of all items in the modulator, see Strings\State in GUI Resource.xml  .g_aReadMatrixStateRead  2300  2555  Uint16    Status bit's array  In this array you can see the unlatched status bit's of all items in the modulator, Bit0: Warning condition exists Bit1: Interlock condition exists  .g_aReadMatrixStatusBits   OutputRegisters  StartAddr  End Addr  Type  Unit  General  Function  VarName  0  0  Uint16    Communication watchdog  Increment this value at least every second (depending on timeout setting in local GUI), used by the modulator to monitor this communication  SR_SlowCall.IFB_ExtComSts.uiModbusTcpWatchdog  1  1  Int16    Modulator target state  This is the target state of the MSM (Main State Machine), example: iStateTarget and iStateRead are both "Off" (1) You request the modulator to "Hv" state by writing 9 to StateTarget See Strings\State in GUI Resource.xml  .g_iStateTargetRem  2  2  Uint16    Command bit's Bit0: Reset Bit1: ECAT control (use .g_rVoltSetEcat)  A word containing 16 command bit's Bit0: Reset (remember to set it back to zero afterwards) Bit1: ECAT control (use .g_rVoltSetEcat)  .g_wCommandBitsRem  100  101  Single  V  Voltage setvalue of all Ccps  Scaled setvalue, range 0-1200VDC  .g_rVoltSetRem  200  201  Single  A  Filament current setvalue  Scaled setvalue, range 0-30ADC  SR_FastCall.IFB_FastKly.IFB_FastFilPS.IFB_CurrSet.ati_rSet1Rem  300  301  Single  µs  Pulse width setvalue of all SU's  Scaled setvalue, range 1-5µs  .g_rPlswthSetRem  800  801  Single  º  Phase shifter set value.  Scaled setvalue, range 0-540 degrees  SR_FastCall.IFB_FastKly.IFB_PhaseShifter.rAngleSetRem   